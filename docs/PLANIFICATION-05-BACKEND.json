{
  "phase": "05",
  "nom": "BACKEND EXPRESS + SUPABASE",
  "description": "API Express TypeScript avec routes contact, articles, auth, email notifications",
  "objectif": "Backend complet avec Supabase, JWT auth, CRUD articles, envoi emails",
  
  "structure_backend": {
    "path": "backend/",
    "organisation": [
      "src/config/ → database, email, jwt",
      "src/middleware/ → auth, validation",
      "src/routes/ → contact, articles, auth, admin",
      "src/controllers/ → logique métier",
      "src/services/ → services tiers (email, db)",
      "src/models/ → interfaces TypeScript"
    ]
  },
  
  "workflow": {
    "regles_absolues": [
      "1 FICHIER = 1 MESSAGE = 1 ARTEFACT",
      "Code COMPLET (jamais '...')",
      "STOP après chaque → ATTENDRE '✓ OK'",
      "Ordre strict",
      "TypeScript strict (aucun 'any')"
    ]
  },
  
  "fichiers": [
    {
      "ordre": 1,
      "nom": "package.json",
      "path": "backend/package.json",
      "type": "Configuration",
      "description": "Dépendances backend",
      "dependances": [
        "express",
        "@supabase/supabase-js",
        "jsonwebtoken",
        "bcrypt",
        "dotenv",
        "cors",
        "express-validator",
        "nodemailer ou resend",
        "typescript",
        "@types/express",
        "@types/jsonwebtoken",
        "@types/bcrypt",
        "@types/node"
      ],
      "scripts": {
        "dev": "tsx watch src/server.ts",
        "build": "tsc",
        "start": "node dist/server.js"
      },
      "instructions": [
        "Toutes dépendances listées",
        "Scripts dev (tsx watch) et prod",
        "TypeScript + types"
      ]
    },
    
    {
      "ordre": 2,
      "nom": "tsconfig.json",
      "path": "backend/tsconfig.json",
      "type": "Configuration",
      "description": "TypeScript config backend",
      "config": {
        "target": "ES2022",
        "module": "commonjs",
        "outDir": "./dist",
        "rootDir": "./src",
        "strict": true
      },
      "instructions": [
        "Mode strict activé",
        "Output: dist/",
        "Paths alias si besoin"
      ]
    },
    
    {
      "ordre": 3,
      "nom": ".env.example",
      "path": "backend/.env.example",
      "type": "Configuration",
      "description": "Variables environnement template",
      "variables": [
        "NODE_ENV=development",
        "PORT=3000",
        "DATABASE_URL=YOUR_SUPABASE_URL",
        "SUPABASE_KEY=YOUR_SUPABASE_SERVICE_KEY",
        "JWT_SECRET=YOUR_JWT_SECRET",
        "EMAIL_SERVICE=resend",
        "EMAIL_API_KEY=YOUR_EMAIL_API_KEY",
        "FRONTEND_URL=http://localhost:4200"
      ],
      "instructions": [
        "Template .env",
        "Commentaires explicatifs",
        "Ne pas commit .env réel"
      ]
    },
    
    {
      "ordre": 4,
      "nom": "database.config.ts",
      "path": "backend/src/config/database.config.ts",
      "type": "Configuration",
      "description": "Config Supabase client",
      "instructions": [
        "Import @supabase/supabase-js",
        "createClient avec URL + KEY",
        "Export supabase client",
        "Type safety avec Database types"
      ]
    },
    
    {
      "ordre": 5,
      "nom": "email.config.ts",
      "path": "backend/src/config/email.config.ts",
      "type": "Configuration",
      "description": "Config email service (Resend ou Nodemailer)",
      "instructions": [
        "Import service email",
        "Config avec API_KEY",
        "Export emailClient",
        "Method sendEmail(to, subject, html)"
      ]
    },
    
    {
      "ordre": 6,
      "nom": "jwt.config.ts",
      "path": "backend/src/config/jwt.config.ts",
      "type": "Configuration",
      "description": "Config JWT",
      "instructions": [
        "Import jsonwebtoken",
        "generateToken(payload)",
        "verifyToken(token)",
        "Secret from env"
      ]
    },
    
    {
      "ordre": 7,
      "nom": "auth.middleware.ts",
      "path": "backend/src/middleware/auth.middleware.ts",
      "type": "Middleware",
      "description": "Middleware auth JWT",
      "instructions": [
        "Verify token from headers",
        "Attach user to req",
        "Return 401 si invalid",
        "Type Request avec user"
      ]
    },
    
    {
      "ordre": 8,
      "nom": "validation.middleware.ts",
      "path": "backend/src/middleware/validation.middleware.ts",
      "type": "Middleware",
      "description": "Middleware validation express-validator",
      "instructions": [
        "Import express-validator",
        "validationResult",
        "Return 400 si erreurs",
        "Format errors array"
      ]
    },
    
    {
      "ordre": 9,
      "nom": "contact.interface.ts",
      "path": "backend/src/models/contact.interface.ts",
      "type": "Interface",
      "description": "Interface Contact backend",
      "structure": {
        "ContactFormData": "même que frontend",
        "ContactDB": "avec id, createdAt, status"
      },
      "instructions": [
        "Sync avec frontend interface",
        "ContactDB pour Supabase",
        "Status: 'nouveau' | 'lu' | 'traité'"
      ]
    },
    
    {
      "ordre": 10,
      "nom": "article.interface.ts",
      "path": "backend/src/models/article.interface.ts",
      "type": "Interface",
      "description": "Interface Article backend",
      "instructions": [
        "Sync avec frontend interface",
        "ArticleDB pour Supabase",
        "ArticleCreateDTO, ArticleUpdateDTO"
      ]
    },
    
    {
      "ordre": 11,
      "nom": "contact.routes.ts",
      "path": "backend/src/routes/contact.routes.ts",
      "type": "Routes",
      "description": "Routes contact",
      "routes": [
        "POST /api/contact → submitContact"
      ],
      "instructions": [
        "Express Router",
        "Validation middleware",
        "Controller submitContact",
        "Export router"
      ]
    },
    
    {
      "ordre": 12,
      "nom": "contact.controller.ts",
      "path": "backend/src/controllers/contact.controller.ts",
      "type": "Controller",
      "description": "Controller contact",
      "methodes": [
        "submitContact: insert Supabase + send email"
      ],
      "instructions": [
        "Insert dans table contacts",
        "Status: 'nouveau'",
        "Send email notification",
        "Return 201 success",
        "Catch errors → 500"
      ]
    },
    
    {
      "ordre": 13,
      "nom": "articles.routes.ts",
      "path": "backend/src/routes/articles.routes.ts",
      "type": "Routes",
      "description": "Routes articles public + admin",
      "routes": [
        "GET /api/articles → getArticles (published only)",
        "GET /api/articles/latest/:count → getLatestArticles",
        "GET /api/articles/:slug → getArticleBySlug",
        "POST /api/articles → createArticle (auth required)",
        "PUT /api/articles/:id → updateArticle (auth required)",
        "DELETE /api/articles/:id → deleteArticle (auth required)",
        "PATCH /api/articles/:id/publish → publishArticle (auth required)"
      ],
      "instructions": [
        "Public: GET sans auth",
        "Admin: POST/PUT/DELETE/PATCH avec authMiddleware",
        "Validation middlewares",
        "Export router"
      ]
    },
    
    {
      "ordre": 14,
      "nom": "articles.controller.ts",
      "path": "backend/src/controllers/articles.controller.ts",
      "type": "Controller",
      "description": "Controller articles CRUD",
      "methodes": [
        "getArticles: filter published, order by publishedAt desc",
        "getLatestArticles: limit N, published",
        "getArticleBySlug: return article + increment views",
        "createArticle: insert with status draft",
        "updateArticle: update fields",
        "deleteArticle: delete by id",
        "publishArticle: set status published + publishedAt"
      ],
      "instructions": [
        "Queries Supabase",
        "Status published pour public",
        "Increment views on read",
        "Auth user from middleware",
        "Return 404 si not found"
      ]
    },
    
    {
      "ordre": 15,
      "nom": "auth.routes.ts",
      "path": "backend/src/routes/auth.routes.ts",
      "type": "Routes",
      "description": "Routes auth admin",
      "routes": [
        "POST /api/auth/login → login"
      ],
      "instructions": [
        "Login avec email + password",
        "Return JWT token",
        "Validation middleware"
      ]
    },
    
    {
      "ordre": 16,
      "nom": "auth.controller.ts",
      "path": "backend/src/controllers/auth.controller.ts",
      "type": "Controller",
      "description": "Controller auth",
      "methodes": [
        "login: verify credentials, generate token"
      ],
      "instructions": [
        "Check user in Supabase ou env",
        "Compare password bcrypt",
        "Generate JWT",
        "Return { token, user }",
        "401 si invalid"
      ]
    },
    
    {
      "ordre": 17,
      "nom": "admin.routes.ts",
      "path": "backend/src/routes/admin.routes.ts",
      "type": "Routes",
      "description": "Routes admin contacts",
      "routes": [
        "GET /api/contacts → getContacts (auth required)",
        "PATCH /api/contacts/:id/status → updateStatus (auth required)"
      ],
      "instructions": [
        "Auth middleware",
        "Get all contacts",
        "Update status (nouveau → lu → traité)"
      ]
    },
    
    {
      "ordre": 18,
      "nom": "admin.controller.ts",
      "path": "backend/src/controllers/admin.controller.ts",
      "type": "Controller",
      "description": "Controller admin",
      "methodes": [
        "getContacts: return all, order by createdAt desc",
        "updateStatus: update contact status"
      ],
      "instructions": [
        "Query Supabase contacts table",
        "Filter by status optionnel",
        "Update status avec validation"
      ]
    },
    
    {
      "ordre": 19,
      "nom": "app.ts",
      "path": "backend/src/app.ts",
      "type": "Express App",
      "description": "Config Express app",
      "middlewares": [
        "cors",
        "express.json()",
        "express.urlencoded()"
      ],
      "routes": [
        "/api/contact",
        "/api/articles",
        "/api/auth",
        "/api/contacts (admin)"
      ],
      "instructions": [
        "Import routes",
        "CORS config",
        "Body parsers",
        "Mount routes",
        "Error handler global",
        "Export app"
      ]
    },
    
    {
      "ordre": 20,
      "nom": "server.ts",
      "path": "backend/src/server.ts",
      "type": "Server",
      "description": "Server entry point",
      "instructions": [
        "Import app",
        "Load dotenv",
        "app.listen(PORT)",
        "Console log server started"
      ]
    },
    
    {
      "ordre": 21,
      "nom": "supabase-tables.sql",
      "path": "backend/supabase-tables.sql",
      "type": "SQL",
      "description": "Schéma tables Supabase",
      "tables": [
        "contacts (id, firstName, lastName, email, phone, company, subject, message, status, createdAt, updatedAt)",
        "articles (id, slug, title, excerpt, content, coverImage, author, publishedAt, updatedAt, status, category, relatedService, tags, readTime, views)"
      ],
      "indexes": [
        "idx_articles_slug",
        "idx_articles_status",
        "idx_articles_published"
      ],
      "instructions": [
        "CREATE TABLE contacts",
        "CREATE TABLE articles",
        "CREATE INDEXes",
        "RLS policies si besoin"
      ]
    }
  ],
  
  "validation_phase": {
    "criteres": [
      "Tous fichiers créés et validés",
      "npm install OK",
      "npm run dev démarre backend",
      "Tables Supabase créées",
      "POST /api/contact fonctionne",
      "GET /api/articles retourne articles",
      "POST /api/auth/login retourne token",
      "Routes admin protégées JWT",
      "Email notification envoyée",
      "CORS configuré"
    ],
    "commandes_test": [
      "cd backend",
      "npm install",
      "npm run dev",
      "curl -X POST http://localhost:3000/api/contact",
      "curl http://localhost:3000/api/articles"
    ]
  },
  
  "notes_importantes": [
    "Supabase tables à créer manuellement",
    "Variables env à configurer",
    "Email service: Resend recommandé (gratuit 100/jour)",
    "JWT secret: générer strong",
    "CORS: allow frontend URL",
    "Validation avec express-validator",
    "Error handling global",
    "Phase 06: admin frontend connecté",
    "1 fichier = 1 validation obligatoire"
  ]
}
