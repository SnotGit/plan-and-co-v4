{
  "phase": "05",
  "nom": "BACKEND API",
  "description": "Création du backend Express en TypeScript avec Supabase et service email",
  "objectif": "API REST fonctionnelle pour contact form + préparation auth admin",
  
  "prerequis": [
    "Phase 04 validée (formulaire contact frontend)",
    "Node.js 18+ installé",
    "Compte Supabase créé (ou à créer)",
    "Compte service email (Resend gratuit ou SendGrid)"
  ],
  
  "architecture_backend": {
    "stack": "Node.js + Express + TypeScript",
    "database": "Supabase (PostgreSQL)",
    "email": "Resend (gratuit 3000/mois) ou SendGrid",
    "auth": "JWT (jsonwebtoken)",
    "validation": "express-validator",
    "deployment": "Render (free tier)"
  },
  
  "configuration_supabase": {
    "etapes": [
      "1. Créer compte sur supabase.com",
      "2. Créer nouveau projet",
      "3. Récupérer URL et clés (anon + service)",
      "4. Créer table 'contacts' via SQL Editor",
      "5. Configurer RLS (Row Level Security)"
    ],
    "table_contacts": {
      "nom": "contacts",
      "colonnes": [
        "id UUID PRIMARY KEY DEFAULT uuid_generate_v4()",
        "first_name TEXT NOT NULL",
        "last_name TEXT NOT NULL",
        "email TEXT NOT NULL",
        "phone TEXT",
        "company TEXT",
        "service TEXT NOT NULL",
        "budget TEXT",
        "message TEXT NOT NULL",
        "status TEXT DEFAULT 'nouveau' CHECK (status IN ('nouveau', 'lu', 'traité'))",
        "created_at TIMESTAMPTZ DEFAULT NOW()",
        "updated_at TIMESTAMPTZ DEFAULT NOW()"
      ],
      "index": [
        "CREATE INDEX idx_contacts_email ON contacts(email);",
        "CREATE INDEX idx_contacts_status ON contacts(status);",
        "CREATE INDEX idx_contacts_created_at ON contacts(created_at DESC);"
      ],
      "rls": [
        "-- Permettre INSERT public (formulaire contact)",
        "CREATE POLICY 'Allow public insert' ON contacts FOR INSERT WITH CHECK (true);",
        "-- Permettre SELECT/UPDATE/DELETE admin uniquement (à configurer avec JWT plus tard)",
        "CREATE POLICY 'Allow admin read' ON contacts FOR SELECT USING (true); -- À sécuriser après"
      ]
    }
  },
  
  "fichiers": [
    {
      "ordre": 1,
      "nom": "package.json",
      "path": "backend/package.json",
      "type": "Configuration",
      "description": "Configuration npm backend avec dépendances Express + TypeScript",
      "dependencies": {
        "express": "^4.18.2",
        "@supabase/supabase-js": "^2.39.0",
        "dotenv": "^16.3.1",
        "cors": "^2.8.5",
        "express-validator": "^7.0.1",
        "jsonwebtoken": "^9.0.2",
        "bcryptjs": "^2.4.3",
        "resend": "^3.0.0"
      },
      "devDependencies": {
        "typescript": "^5.3.0",
        "@types/node": "^20.10.0",
        "@types/express": "^4.17.21",
        "@types/cors": "^2.8.17",
        "@types/jsonwebtoken": "^9.0.5",
        "@types/bcryptjs": "^2.4.6",
        "tsx": "^4.7.0",
        "nodemon": "^3.0.2"
      },
      "scripts": {
        "dev": "nodemon --exec tsx src/server.ts",
        "build": "tsc",
        "start": "node dist/server.js"
      },
      "instructions": [
        "Créer package.json complet",
        "Versions récentes des packages",
        "Scripts dev (tsx + nodemon) et prod (tsc + node)",
        "Type: module ou commonjs (à choisir)"
      ]
    },
    
    {
      "ordre": 2,
      "nom": "tsconfig.json",
      "path": "backend/tsconfig.json",
      "type": "Configuration",
      "description": "Configuration TypeScript backend strict",
      "config": {
        "compilerOptions": {
          "target": "ES2022",
          "module": "commonjs",
          "outDir": "./dist",
          "rootDir": "./src",
          "strict": true,
          "esModuleInterop": true,
          "skipLibCheck": true,
          "forceConsistentCasingInFileNames": true,
          "resolveJsonModule": true
        },
        "include": ["src/**/*"],
        "exclude": ["node_modules", "dist"]
      },
      "instructions": [
        "Mode strict OBLIGATOIRE",
        "outDir: dist, rootDir: src",
        "Target ES2022",
        "Aucun any autorisé"
      ]
    },
    
    {
      "ordre": 3,
      "nom": ".env.example",
      "path": "backend/.env.example",
      "type": "Configuration",
      "description": "Template variables environnement (git committed)",
      "variables": [
        "NODE_ENV=development",
        "PORT=3000",
        "SUPABASE_URL=your_supabase_url",
        "SUPABASE_SERVICE_KEY=your_supabase_service_key",
        "JWT_SECRET=your_jwt_secret_min_32_chars",
        "RESEND_API_KEY=your_resend_api_key",
        "ADMIN_EMAIL=planandco9@gmail.com",
        "FRONTEND_URL=http://localhost:4200"
      ],
      "instructions": [
        "Fichier template (committé)",
        "Commentaires pour expliquer où obtenir les clés",
        "Pas de vraies valeurs"
      ]
    },
    
    {
      "ordre": 4,
      "nom": ".gitignore",
      "path": "backend/.gitignore",
      "type": "Configuration",
      "description": "Fichiers à ignorer par Git",
      "content": [
        "node_modules/",
        "dist/",
        ".env",
        ".env.local",
        "*.log"
      ],
      "instructions": [
        "Ignorer node_modules et dist",
        "Ignorer .env (secrets)",
        "Ignorer logs"
      ]
    },
    
    {
      "ordre": 5,
      "nom": "contact.interface.ts",
      "path": "backend/src/models/contact.interface.ts",
      "type": "Interface",
      "description": "Interfaces TypeScript pour Contact (identique frontend)",
      "interfaces": [
        "ContactFormData (données reçues du frontend)",
        "Contact (données BDD avec id, status, timestamps)"
      ],
      "instructions": [
        "Export interface ContactFormData { ... }",
        "Export interface Contact extends ContactFormData { id, status, created_at, updated_at }",
        "Typage strict",
        "Même structure que frontend"
      ]
    },
    
    {
      "ordre": 6,
      "nom": "database.ts",
      "path": "backend/src/config/database.ts",
      "type": "Configuration",
      "description": "Configuration et connexion Supabase",
      "logique": [
        "Import createClient from @supabase/supabase-js",
        "Créer client Supabase avec URL et service key",
        "Export client pour utilisation dans services"
      ],
      "instructions": [
        "Import dotenv/config en premier",
        "Créer supabaseClient avec createClient()",
        "URL et key depuis process.env",
        "Vérifier variables existent (throw si manquantes)",
        "Export const supabase",
        "Typage strict"
      ]
    },
    
    {
      "ordre": 7,
      "nom": "email.ts",
      "path": "backend/src/config/email.ts",
      "type": "Configuration",
      "description": "Configuration service email (Resend)",
      "logique": [
        "Import Resend from 'resend'",
        "Créer instance Resend avec API key",
        "Export pour utilisation dans services"
      ],
      "instructions": [
        "Import dotenv/config",
        "Créer const resend = new Resend(process.env.RESEND_API_KEY)",
        "Vérifier API key existe",
        "Export const resend",
        "Typage strict"
      ]
    },
    
    {
      "ordre": 8,
      "nom": "validation.middleware.ts",
      "path": "backend/src/middleware/validation.middleware.ts",
      "type": "Middleware",
      "description": "Middleware validation données avec express-validator",
      "validations": {
        "validateContact": [
          "body('firstName').notEmpty().trim().isLength({ min: 2 })",
          "body('lastName').notEmpty().trim().isLength({ min: 2 })",
          "body('email').isEmail().normalizeEmail()",
          "body('phone').optional().matches(/^[0-9\\s\\+\\-]+$/)",
          "body('service').notEmpty()",
          "body('message').notEmpty().isLength({ min: 10 })"
        ]
      },
      "instructions": [
        "Import { body, validationResult } from 'express-validator'",
        "Export array validateContact avec rules",
        "Export middleware handleValidationErrors",
        "handleValidationErrors: check errors, return 400 si erreurs",
        "Typage Request, Response, NextFunction"
      ]
    },
    
    {
      "ordre": 9,
      "nom": "contact.service.ts",
      "path": "backend/src/services/contact.service.ts",
      "type": "Service",
      "description": "Service métier pour gérer les contacts (save Supabase + email)",
      "methodes": [
        "async createContact(data: ContactFormData): Promise<Contact>",
        "async sendNotificationEmail(contact: Contact): Promise<void>"
      ],
      "logique_createContact": [
        "Insérer contact dans Supabase (table contacts)",
        "Vérifier erreur insert",
        "Retourner contact créé avec id"
      ],
      "logique_sendEmail": [
        "Utiliser Resend pour envoyer email admin",
        "Destinataire: ADMIN_EMAIL",
        "Sujet: Nouveau contact - Plan & Co",
        "Body HTML avec détails contact"
      ],
      "instructions": [
        "Import supabase depuis config/database",
        "Import resend depuis config/email",
        "Méthode createContact: .insert() dans 'contacts'",
        "Gérer erreurs Supabase",
        "Méthode sendEmail: resend.emails.send()",
        "Template email HTML simple",
        "Typage strict, async/await"
      ]
    },
    
    {
      "ordre": 10,
      "nom": "contact.controller.ts",
      "path": "backend/src/controllers/contact.controller.ts",
      "type": "Controller",
      "description": "Controller HTTP pour route POST /api/contact",
      "methode": "async submitContact(req: Request, res: Response)",
      "logique": [
        "Extraire données body (ContactFormData)",
        "Appeler contactService.createContact()",
        "Appeler contactService.sendNotificationEmail()",
        "Retourner 201 { success: true, message: 'Contact enregistré' }",
        "Catch erreurs → 500 { success: false, message: error }"
      ],
      "instructions": [
        "Import Request, Response from express",
        "Import ContactFormData interface",
        "Import contactService",
        "Async function submitContact",
        "Try/catch avec gestion erreurs",
        "Status 201 si success, 500 si error",
        "Typage strict"
      ]
    },
    
    {
      "ordre": 11,
      "nom": "contact.routes.ts",
      "path": "backend/src/routes/contact.routes.ts",
      "type": "Routes",
      "description": "Routes Express pour contact",
      "route": "POST /api/contact",
      "middlewares": [
        "validateContact (validation)",
        "handleValidationErrors",
        "submitContact (controller)"
      ],
      "instructions": [
        "Import { Router } from 'express'",
        "Import controller et middlewares",
        "Créer router = Router()",
        "router.post('/', validateContact, handleValidationErrors, submitContact)",
        "Export default router",
        "Typage strict"
      ]
    },
    
    {
      "ordre": 12,
      "nom": "app.ts",
      "path": "backend/src/app.ts",
      "type": "Application",
      "description": "Configuration Express principale (middlewares, routes)",
      "middlewares": [
        "cors({ origin: FRONTEND_URL })",
        "express.json()",
        "express.urlencoded({ extended: true })"
      ],
      "routes": [
        "app.use('/api/contact', contactRoutes)"
      ],
      "instructions": [
        "Import express, cors, dotenv",
        "Import routes",
        "Créer app = express()",
        "Middleware CORS (whitelist frontend)",
        "Middleware JSON parser",
        "Monter routes (/api/contact)",
        "Route 404 handler",
        "Error handler global",
        "Export app",
        "Typage strict"
      ]
    },
    
    {
      "ordre": 13,
      "nom": "server.ts",
      "path": "backend/src/server.ts",
      "type": "Entry Point",
      "description": "Point d'entrée serveur (listen port)",
      "logique": [
        "Import app from './app'",
        "Import dotenv/config",
        "const PORT = process.env.PORT || 3000",
        "app.listen(PORT, callback)"
      ],
      "instructions": [
        "Import app",
        "dotenv config",
        "PORT depuis env ou 3000",
        "app.listen avec console.log",
        "Minimal et propre"
      ]
    },
    
    {
      "ordre": 14,
      "nom": "README.md",
      "path": "backend/README.md",
      "type": "Documentation",
      "description": "Documentation backend (installation, env vars, endpoints)",
      "sections": [
        "Description",
        "Stack technique",
        "Installation (npm install)",
        "Variables environnement (.env)",
        "Commandes (npm run dev, build, start)",
        "Endpoints API",
        "Déploiement Render"
      ],
      "instructions": [
        "Documentation claire",
        "Lister toutes variables .env",
        "Décrire chaque endpoint (method, body, response)",
        "Expliquer setup Supabase",
        "Guide déploiement Render"
      ]
    }
  ],
  
  "validation_phase": {
    "criteres": [
      "Backend démarre sans erreur (npm run dev)",
      "POST /api/contact fonctionne",
      "Données sauvegardées dans Supabase",
      "Email notification reçu (si configuré)",
      "Validation formulaire côté serveur active",
      "CORS configuré (frontend peut appeler)",
      "Erreurs gérées proprement (500, 400)",
      "Aucune erreur TypeScript"
    ],
    "commandes_test": [
      "cd backend",
      "npm install",
      "Créer .env avec vraies valeurs",
      "npm run dev",
      "Tester avec Postman/Thunder Client:",
      "  POST http://localhost:3000/api/contact",
      "  Body JSON: { firstName, lastName, email, service, message }",
      "Vérifier Supabase → nouveau contact",
      "Vérifier email reçu"
    ],
    "test_integration_frontend": [
      "Démarrer backend (npm run dev)",
      "Démarrer frontend (ng serve)",
      "Soumettre formulaire contact",
      "Vérifier success message",
      "Vérifier contact dans Supabase"
    ]
  },
  
  "notes_importantes": [
    "Créer compte Supabase AVANT cette phase",
    "Créer compte Resend (gratuit) ou SendGrid",
    "Configurer table contacts dans Supabase SQL Editor",
    "Créer .env avec vraies valeurs (copier .env.example)",
    "Tester avec Postman avant d'intégrer frontend",
    "Phase longue (14 fichiers), prendre le temps",
    "Workflow strict: 1 fichier = 1 validation",
    "Auth admin sera ajoutée en Phase 06"
  ],
  
  "integration_frontend": {
    "note": "Après validation backend, le formulaire frontend devrait fonctionner",
    "test": "Soumettre formulaire → success message → contact en BDD",
    "cors": "Vérifier CORS autorise http://localhost:4200"
  },
  
  "deployment_render": {
    "etapes": [
      "1. Push code sur GitHub",
      "2. Créer compte Render.com",
      "3. New Web Service → Connect repository",
      "4. Build Command: npm install && npm run build",
      "5. Start Command: npm start",
      "6. Ajouter variables environnement dans Render dashboard",
      "7. Deploy (auto à chaque push)"
    ],
    "url_production": "https://planandco-api.onrender.com",
    "note": "Free tier: serveur dort après 15min inactivité"
  }
}